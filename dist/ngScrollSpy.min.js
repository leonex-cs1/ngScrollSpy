/*
Copyright (c) 2014 Magnús Örn Gylfason
Licence: MIT
*/
!function(t){"use strict";function e(){return o}var n=t.module("ngScrollSpy",[]);n.service("ScrollSpy",["$window",function(e){var n,o=function(t){var e=(t.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,t.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,void 0!==t.pageXOffset),n="CSS1Compat"===(document.compatMode||""),o=(e?t.pageXOffset:n?document.documentElement.scrollLeft:document.body.scrollLeft,e?t.pageYOffset:n?document.documentElement.scrollTop:document.body.scrollTop,{width:t.innerWidth,height:t.innerHeight,maxWidth:t.document.body.scrollWidth,maxHeight:t.document.body.scrollHeight,posX:t.scrollX||t.pageXOffset||t.document.documentElement.scrollLeft,posY:t.scrollY||t.pageYOffset||t.document.documentElement.scrollTop});return o.posX<0?(o.posX=0,o.overscrollLeft=!0):o.posX+o.width>o.maxWidth&&(o.posX=o.maxWidth-o.width,o.overscrollRight=!0),o.posY<0?(o.posY=0,o.overscrollTop=!0):o.posY+o.height>o.maxHeight&&(o.posY=o.maxHeight-o.height,o.overscrollBottom=!0),o.hasOverscroll=o.overscrollTop||o.overscrollBottom||o.overscrollLeft||o.overscrollRight,o},r=function(e,n){if(!e||!n)return t.extend({isEqual:!1,velocityX:0,velocityY:0},n);var o={posX:n.posX-e.posX,posY:n.posY-e.posY,width:n.width-e.width,height:n.height-e.height,maxWidth:n.maxWidth-e.maxWidth,maxHeight:n.maxHeight-e.maxHeight};return n.width>0&&(o.velocityX=o.posX/n.width),n.height>0&&(o.velocityY=o.posY/n.height),o.isEqual=!(0!==o.posX||0!==o.posY||0!==o.width||0!==o.height||0!==o.maxWidth||0!==o.maxHeight),o},i={},l=function(t){var l=o(e),s=r(n,l);if(!s.isEqual||l.hasOverscroll||t){for(var c in i){var a=i[c].cond;(a(l,s)||t)&&i[c].handler(l,s)}n=l}};t.element(e).on("scroll",l);var s=this,c=0;this.trigger=function(){this.isForced=!0,l(!0),this.isForced=!1},this.addHandler=function(t,e){return i[c]={cond:t,handler:e},c++,c-1},this.removeHandler=function(t){delete i[t]},this.onScroll=function(t){return s.addHandler(function(){return!0},function(e,n){t(e,n)})},this.onXScroll=function(t){return s.addHandler(function(t,e){return 0!==e.posX},function(e,n){t(e.posX,n.posX,e,n)})},this.onYScroll=function(t){return s.addHandler(function(t,e){return 0!==e.posY},function(e,n){t(e.posY,n.posY,e,n)})},this.onOverscrollHorz=function(t){return s.addHandler(function(t,e){return t.overscrollLeft||t.overscrollRight},t)},this.onOverscrollLeft=function(t){return s.addHandler(function(t,e){return t.overscrollLeft},t)},this.onOverscrollRight=function(t){return s.addHandler(function(t,e){return t.overscrollRight},t)},this.onOverscrollVert=function(t){return s.addHandler(function(t,e){return t.overscrollTop||t.overscrollBottom},t)},this.onOverscrollTop=function(t){return s.addHandler(function(t,e){return t.overscrollTop},t)},this.onOverscrollBottom=function(t){return s.addHandler(function(t,e){return t.overscrollBottom},t)}}]),n.directive("affix",["ScrollSpy",function(e){var n,o=function(t){if(!t.prop("ngScrollSpy")){var e=t.clone();t.prop("ngScrollSpy",{placeholder:e,refreshPlaceholder:function(){var n=t.clone();e[0].parentNode&&e[0].parentNode.replaceChild(n[0],e[0]),t.prop("ngScrollSpy").placeholder=n}})}return t.prop("ngScrollSpy").placeholder},r=function(t,e,n,r,i){var l=t(i[0].getBoundingClientRect());l!==e&&(l?(r.placeholder&&i.after(o(i)),i.addClass(n)):(r.placeholder&&o(i).detach(),i.removeClass(n)))},i=function(o,i,l,s){var c,a=!1,u=!1,f=!1;l=t.extend({offset:0,placeholder:!1},l),"top"===o?n=e.onYScroll(function(t){u=a,r(function(e){return a?a=c<=t+l.offset:e.top<=l.offset?(c=e.top<l.offset?t+e.top:t,a=!0):!1},u,i,l,s)}):"bottom"===o?(f=!0,n=e.onYScroll(function(t,n,o){u=a,r(function(n){return a?a=c>=t:n.bottom>=o.height?(c=e.isForced&&0===t?t+n.bottom-o.height-n.height:t+n.bottom-o.height,a=!0):!1},u,i,l,s)})):"left"===o?n=e.onXScroll(function(t){u=a,r(function(e){return a?a=t>=c:e.left<=0?(c=e.left<0?t+e.left:t,a=!0):!1},u,i,l,s)}):"right"===o&&(f=!0,n=e.onXScroll(function(t,n,o){u=a,r(function(n){return a?a=c>=t:n.right>=o.width?(c=e.isForced&&0===t?t+n.right-o.width-n.width:t+n.right-o.width,a=!0):!1},u,i,l,s)})),f&&e.trigger()};return{restrict:"A",scope:{affix:"@",affixClass:"@",affixOptions:"@"},link:function(t,o,r,l){t.affix=t.affix||"top",t.affixClass=t.affixClass||"affix",t.affixOptions=t.affixOptions?t.$eval(t.affixOptions):{},i(t.affix,t.affixClass,t.affixOptions,o),t.$on("destroy",function(){e.removeHandler(n)})}}}]);var o={onRun:null,state:null,store:function(t){for(var e in t)this[e]=t[e];this.state=!0,this.run()},builder:null,setBuilder:function(t){this.builder=t,this.run()},run:function(){this.builder&&this.state&&(this.builder(),this.builder=null,this.state=null,this.onRun&&(this.onRun(),this.onRun=null))}};n.directive("pageitems",["ScrollSpy",function(n){var o=function(o,r,i){if(t.isDefined(o.selector)){o.spyElems=r[0].getElementsByClassName(o.selector),o.spies={},e().onRun=function(){o.spies[o.spyElems[0].id].set()},e().store({topMargin:function(){return 0|o.topmargin},addSpy:function(t){o.spies[t.id]=t},getSpy:function(t){return o.spies[t]},items:function(){return o.spyElems}});var l=o.spyElems,s=0|o.topmargin,c=n.onYScroll(function(t,e,r){for(var i=null,a=o.spies,u=0;u<l.length;u++){var f=l[u],d=a[f.id];if(d.clear(),void 0!==f.getBoundingClientRect().top){var p=f.getBoundingClientRect().top;s>=p?(d.pos=p,null===i&&(i=d),i.pos<d.pos&&(i=d)):null===i&&(i=d)}}r.height+t>=r.maxHeight&&(i=a[l[l.length-1].id]),i.set(),o.$on("destroy",function(){n.removeHandler(c)})})}};return{restrict:"A",scope:{selector:"@",topmargin:"@"},link:o}}]),n.directive("pagemenu",["$compile","$location","$anchorScroll",function(t,n,o){var r=function(r,i){for(var l,s=[],c=[],a=function(t){for(var e={link:t.id,text:t.textContent||t.innerText,parent:""},n=t.tagName,o=0;o<t.classList.length;o++)n+=","+t.classList[o];var r=s.length;if(0===r)s.push(n);else if(n!==s[r-1]){for(var i=r-1;i>=0&&n!=s[i];i--);if(0>i)s.push(n),e.push=!0,c.push(l);else for(e.pop=r-1-i;s.length>i+1;)s.pop(),c.pop()}return c.length>0&&(e.parent=c[c.length-1]),l=e.link,e},u=e().items(),f="",d=0;d<u.length;d++){var p=a(u[d]);if(p.push)f+='<menu class="nav">';else if(p.pop)for(var h=0;h<p.pop;h++)f+="</li></menu>";else 0!==d&&(f+="</li>");f+='<li pagemenuspy="'+p.link+'" parent="'+p.parent+'">',f+='<a href="#'+p.link+'">',f+=p.text,f+="</a>"}f+="</li>",i.append(t(f)(r)),i.on("click",function(t){var r=t.target.hash.substring(1);n.hash(r),o(),0!==e().topMargin()&&setTimeout(function(){window.scrollTo(window.pageXOffset,window.pageYOffset-e().topMargin())},0)})};return{restrict:"E",replace:!0,template:'<menu class="nav pagemenu"></menu>',link:function(t,n){e().setBuilder(function(){r(t,n)})}}}]),n.directive("pagemenuspy",["$location","$anchorScroll",function(t,n){return{restrict:"A",link:function(t,n,o){e().addSpy({id:o.pagemenuspy,parent:o.parent,set:function(){n.addClass("active");var t=e().getSpy(this.parent);t&&t.set()},clear:function(){n.removeClass("active")}})}}}])}(angular);